#!/bin/sh

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Check if --no-verify flag was used
if [ "$HUSKY_SKIP_HOOKS" = "1" ]; then
  echo "${YELLOW}‚ö†Ô∏è  Skipping pre-push checks${NC}"
  exit 0
fi

echo "${GREEN}üöÄ Running pre-push checks...${NC}"

# Run type check
# Temporarily disabled while fixing test-utils types
# echo "${GREEN}üìù Running type check...${NC}"
# npm run type-check || {
#   echo "${RED}‚ùå Type check failed${NC}"
#   echo "${YELLOW}Fix type errors before pushing or use git push --no-verify to skip${NC}"
#   exit 1
# }

# Run lint check (without fixing)
echo "${GREEN}üîç Running lint check...${NC}"
npm run lint || {
  echo "${RED}‚ùå Lint check failed${NC}"
  echo "${YELLOW}Fix lint errors before pushing or use git push --no-verify to skip${NC}"
  exit 1
}

# Run affected tests based on changed files
echo "${GREEN}üß™ Running affected tests...${NC}"
CHANGED_FILES=$(git diff --name-only origin/main...HEAD)

if echo "$CHANGED_FILES" | grep -q "^firebase/functions/"; then
  echo "${GREEN}Running functions tests...${NC}"
  npm run test:functions || {
    echo "${RED}‚ùå Functions tests failed${NC}"
    exit 1
  }
fi

if echo "$CHANGED_FILES" | grep -q "^app/"; then
  echo "${GREEN}Running app tests...${NC}"
  npm run test:app || {
    echo "${RED}‚ùå App tests failed${NC}"
    exit 1
  }
fi

echo "${GREEN}‚úÖ All pre-push checks passed!${NC}" 